<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Defend the Factory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{margin:0;height:100%;background:#1e1b1b;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    #game{display:flex;align-items:center;justify-content:center;height:100%}
    canvas{image-rendering:pixelated}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
<div id="game"></div>
<script>
(() => {
  const W=960, H=540;
  const VERSION='0.0.7';
  let coins=100;
  let baseHP=100;
  let wave=1;

  class Boot extends Phaser.Scene {
    constructor(){ super('boot'); }
    preload(){
      // sprites
      this.load.spritesheet('zombie','resources/sprites/zombie.png',{frameWidth:32,frameHeight:32});
      this.load.spritesheet('robot','resources/sprites/robot.png',{frameWidth:48,frameHeight:48});
      this.load.spritesheet('boss','resources/sprites/boss.png',{frameWidth:48,frameHeight:48});
      this.load.image('turret','resources/sprites/product_turret.png');
      // tiles
      this.load.spritesheet('conveyor','resources/tiles/conveyor.png',{frameWidth:32,frameHeight:32});
      this.load.spritesheet('conveyor_corner','resources/tiles/conveyor_cross.png',{frameWidth:32,frameHeight:32});
      this.load.image('floor','resources/tiles/floor.png');
      this.load.image('out','resources/tiles/out.png');
      // ui
      this.load.image('coin','resources/ui/coin.png');
      this.load.image('wave_banner','resources/ui/wave_banner.png');
      this.load.image('btn_produce','resources/ui/btn_produce.png');
      this.load.image('chest','resources/ui/chest.png');
      this.load.image('pickup_dollar','resources/ui/pickup_dollar.png');
      // effects
      this.load.image('laser','resources/effects/laser.png');
    }
    create(){
      this.anims.create({key:'zombie_walk',frames:this.anims.generateFrameNumbers('zombie',{start:0,end:3}),frameRate:6,repeat:-1});
      this.anims.create({key:'robot_walk',frames:this.anims.generateFrameNumbers('robot',{start:0,end:2}),frameRate:6,repeat:-1});
      this.anims.create({key:'boss_walk',frames:this.anims.generateFrameNumbers('boss',{start:0,end:1}),frameRate:6,repeat:-1});
      // slow the belt animation so tiles appear to move more gently
      this.anims.create({key:'belt_move',frames:this.anims.generateFrameNumbers('conveyor',{start:0,end:1}),frameRate:3,repeat:-1});
      this.anims.create({key:'belt_corner',frames:this.anims.generateFrameNumbers('conveyor_corner',{start:0,end:1}),frameRate:3,repeat:-1});
      this.scene.start('title');
    }
  }

  class Title extends Phaser.Scene {
    constructor(){ super('title'); }
    create(){
      this.add.text(W/2,H/2-60,'Defend the Factory',{fontSize:48,color:'#fff'}).setOrigin(0.5);
      this.add.text(W/2,H/2,'Version '+VERSION,{fontSize:20,color:'#fff'}).setOrigin(0.5);
      this.add.text(W/2,H/2+60,'Tap to Start',{fontSize:24,color:'#fff'}).setOrigin(0.5);
      this.input.once('pointerdown',()=>this.scene.start('quest'));
    }
  }

  class Quest extends Phaser.Scene {
    constructor(){ super('quest'); }
    create(){
      this.add.text(W/2,H/2-20,'Stage 1',{fontSize:32,color:'#fff'}).setOrigin(0.5);
      this.add.text(W/2,H/2+20,'Defend the factory from zombies',{fontSize:24,color:'#fff'}).setOrigin(0.5);
      this.add.text(W/2,H-60,'Tap to Start',{fontSize:24,color:'#fff'}).setOrigin(0.5);
      this.input.once('pointerdown',()=>this.scene.start('main'));
    }
  }

  class Main extends Phaser.Scene {
    constructor(){ super('main'); }
    create(){
      this.add.tileSprite(0,0,W,H,'floor').setOrigin(0);

      // build conveyor loop
      this.buildConveyor();

      // path for products
      this.path=new Phaser.Curves.Path(256,352);
      this.path.lineTo(704,352).lineTo(704,192).lineTo(256,192).lineTo(256,352);

      // groups
      this.products=this.add.group();
      this.enemies=this.physics.add.group();
      this.bullets=this.physics.add.group({allowGravity:false});
      this.drops=this.physics.add.group({allowGravity:false});

      // UI
      this.buildUI();
      this.updateUI();

      // collisions
      this.physics.add.overlap(this.bullets,this.enemies,(b,e)=>{
        e.hp-=b.damage; b.destroy();
        if(e.hp<=0) this.killEnemy(e);
      });

      // spawn timer
      this.spawnDelay=4500;
      this.spawnEnemy();
    }

    buildConveyor(){
      // straight segments
      for(let x=256;x<=704;x+=32){
        this.add.sprite(x,192,'conveyor').play('belt_move');
        this.add.sprite(x,352,'conveyor').play('belt_move');
      }
      for(let y=224;y<352;y+=32){
        this.add.sprite(256,y,'conveyor').setAngle(90).play('belt_move');
        this.add.sprite(704,y,'conveyor').setAngle(90).play('belt_move');
      }
      // corners
      this.add.sprite(256,192,'conveyor_corner').setAngle(180).play('belt_corner');
      this.add.sprite(704,192,'conveyor_corner').setAngle(270).play('belt_corner');
      this.add.sprite(256,352,'conveyor_corner').setAngle(90).play('belt_corner');
      this.add.sprite(704,352,'conveyor_corner').setAngle(0).play('belt_corner');
      // out tile
      this.add.image(480,352,'out').setOrigin(0.5,0);
    }

    buildUI(){
      // next enemy preview
      const box=this.add.rectangle(16,16,128,64,0x000000,0.3).setOrigin(0).setStrokeStyle(2,0xffffff);
      this.add.text(24,24,'Next',{fontSize:16,color:'#fff'});
      this.nextIcons=[];
      for(let i=0;i<3;i++){
        const icon=this.add.sprite(48+i*40,56,'zombie',0).setFlipX(true);
        this.nextIcons.push(icon);
      }

      // wave banner and hp bar
      this.add.image(W/2,16,'wave_banner').setOrigin(0.5,0);
      this.waveText=this.add.text(W/2,28,'WAVE '+wave,{fontSize:20,color:'#fff'}).setOrigin(0.5);
      this.hpLabel=this.add.text(W/2-110,76,'HP',{fontSize:16,color:'#fff'}).setOrigin(0.5);
      this.hpBarBg=this.add.rectangle(W/2,80,200,16,0x555555).setOrigin(0.5);
      this.hpBar=this.add.rectangle(W/2-100,80,200,16,0xff7f00).setOrigin(0,0.5);
      this.hpValue=this.add.text(W/2+110,76,String(baseHP),{fontSize:16,color:'#fff'}).setOrigin(1,0.5);

      // coin counter
      this.add.image(W-40,24,'coin');
      this.coinText=this.add.text(W-48,16,'0',{fontSize:18,color:'#fff'}).setOrigin(1,0);

      // production slots
      this.slots=[];
      for(let i=0;i<3;i++){
        const s=this.add.rectangle(64+i*72,H-48,64,64,0x000000,0.3)
          .setStrokeStyle(2,0xffffff).setOrigin(0.5)
          .setInteractive({useHandCursor:true});
        this.slots.push(s);
      }
      // turret product in first slot
      const turretIcon=this.add.image(this.slots[0].x,this.slots[0].y,'turret').setInteractive({useHandCursor:true});
      turretIcon.on('pointerdown',()=>this.slots[0].emit('pointerdown'));
      this.add.image(this.slots[0].x-20,this.slots[0].y+20,'coin').setScale(0.75);
      this.add.text(this.slots[0].x-6,this.slots[0].y+12,'50',{fontSize:14,color:'#fff'});
      this.slots[0].on('pointerdown',()=>{
        if(coins>=50 && this.canPlaceProduct()){
          coins-=50; this.spawnProduct(); this.updateUI();
        }
      });
    }

    canPlaceProduct(){
      return !this.products.getChildren().some(p=>p.progress<0.08);
    }

    spawnProduct(){
      const p=this.add.sprite(0,0,'turret');
      this.physics.add.existing(p);
      p.body.setAllowGravity(false);
      p.progress=0;
      const start=this.path.getPoint(0);
      p.setPosition(start.x,start.y);
      // halve conveyor traversal speed so products move slower along the belt
      p.speed=0.0001; // progress per ms
      p.range=160;
      p.damage=30;
      p.fireRate=1000;
      p.cooldown=0;
      p.hp=100;
      this.products.add(p);
    }

    spawnEnemy(){
      // spawn at a random screen edge
      const edge=Phaser.Math.Between(0,3);
      let x,y;
      if(edge===0){ // left
        x=-20; y=Phaser.Math.Between(0,H);
      }else if(edge===1){ // right
        x=W+20; y=Phaser.Math.Between(0,H);
      }else if(edge===2){ // top
        x=Phaser.Math.Between(0,W); y=-20;
      }else{ // bottom
        x=Phaser.Math.Between(0,W); y=H+20;
      }

      // select enemy type
      const types=[
        {key:'zombie',anim:'zombie_walk',hp:100,speed:30},
        {key:'robot',anim:'robot_walk',hp:150,speed:25},
        {key:'boss',anim:'boss_walk',hp:300,speed:20}
      ];
      const t=Phaser.Utils.Array.GetRandom(types);

      const e=this.physics.add.sprite(x,y,t.key).setScale(0.2);
      e.anims.play(t.anim);
      e.hp=t.hp;
      e.body.setAllowGravity(false);

      // move toward conveyor center
      const targetX=W/2, targetY=H/2;
      this.physics.moveTo(e,targetX,targetY,t.speed);
      e.setFlipX(e.body.velocity.x>0);
      this.enemies.add(e);

      // schedule next spawn with accelerating delay
      this.spawnDelay=Math.max(1000,this.spawnDelay*0.97);
      this.time.delayedCall(this.spawnDelay,this.spawnEnemy,[],this);
    }

    killEnemy(e){
      const drop=this.add.image(e.x,e.y,'coin').setInteractive({useHandCursor:true});
      this.drops.add(drop);
      drop.on('pointerdown',()=>{coins+=10; drop.destroy(); this.updateUI();});
      e.destroy();
    }

    fireLaser(p,target){
      const b=this.physics.add.image(p.x,p.y,'laser');
      b.damage=p.damage;
      this.physics.moveTo(b,target.x,target.y,400);
      this.bullets.add(b);
      this.time.delayedCall(500,()=>b.destroy());
    }

    getTarget(p){
      let best=null,bestD=1e9;
      this.enemies.getChildren().forEach(z=>{
        const d=Phaser.Math.Distance.Between(p.x,p.y,z.x,z.y);
        if(d<p.range && d<bestD){best=z;bestD=d;}
      });
      return best;
    }

    update(_t,dt){
      // move products along path
      this.products.getChildren().forEach(p=>{
        p.progress+=p.speed*dt;
        if(p.progress>1) p.progress-=1;
        const pt=this.path.getPoint(p.progress);
        p.setPosition(pt.x,pt.y);
        p.cooldown-=dt;
        if(p.cooldown<=0){
          const t=this.getTarget(p);
          if(t){this.fireLaser(p,t);p.cooldown=p.fireRate;}
        }
      });

      // check enemies reaching conveyor center
      this.enemies.getChildren().forEach(z=>{
        if(Phaser.Math.Distance.Between(z.x,z.y,W/2,H/2)<32){
          baseHP-=10; z.destroy(); this.updateUI();
        }
      });
    }

    updateUI(){
      this.coinText.setText(coins);
      this.hpValue.setText(baseHP);
      this.hpBar.width=200*(baseHP/100);
    }
  }

  const config={
    type:Phaser.AUTO,
    width:W,height:H,
    parent:'game',
    backgroundColor:'#1e1b1b',
    physics:{default:'arcade',arcade:{debug:false}},
    scene:[Boot,Title,Quest,Main]
  };
  new Phaser.Game(config);
})();
</script>
</body>
</html>

