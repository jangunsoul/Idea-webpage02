<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Defend the Factory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{margin:0;height:100%;background:#1e1b1b;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    #game{display:flex;align-items:center;justify-content:center;height:100%}
    canvas{image-rendering:pixelated}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
<div id="game"></div>
<script>
(() => {
  const W=960, H=540;
  let coins=0;
  let baseHP=100;

  class Boot extends Phaser.Scene {
    constructor(){ super('boot'); }
    preload(){
      this.load.spritesheet('zombie','resources/sprites/zombie.png',{frameWidth:32,frameHeight:32});
      this.load.image('turret','resources/sprites/product_turret.png');
      this.load.spritesheet('conveyor','resources/tiles/conveyor.png',{frameWidth:64,frameHeight:32});
      this.load.image('floor','resources/tiles/floor.png');
      this.load.image('coin','resources/ui/coin.png');
      this.load.image('laser','resources/effects/laser.png');
    }
    create(){
      this.anims.create({key:'zombie_walk',frames:this.anims.generateFrameNumbers('zombie',{start:0,end:3}),frameRate:6,repeat:-1});
      this.anims.create({key:'belt_move',frames:this.anims.generateFrameNumbers('conveyor',{start:0,end:1}),frameRate:6,repeat:-1});
      this.scene.start('title');
    }
  }

  class Title extends Phaser.Scene {
    constructor(){ super('title'); }
    create(){
      this.add.text(W/2,H/2-40,'Defend the Factory',{fontSize:48,color:'#fff'}).setOrigin(0.5);
      this.add.text(W/2,H/2+40,'Tap to Start',{fontSize:24,color:'#fff'}).setOrigin(0.5);
      this.input.once('pointerdown',()=>this.scene.start('quest'));
    }
  }

  class Quest extends Phaser.Scene {
    constructor(){ super('quest'); }
    create(){
      this.add.text(W/2,H/2-20,'Stage 1',{fontSize:32,color:'#fff'}).setOrigin(0.5);
      this.add.text(W/2,H/2+20,'Defend the factory from zombies',{fontSize:24,color:'#fff'}).setOrigin(0.5);
      this.add.text(W/2,H-60,'Tap to Start',{fontSize:24,color:'#fff'}).setOrigin(0.5);
      this.input.once('pointerdown',()=>this.scene.start('main'));
    }
  }

  class Main extends Phaser.Scene {
    constructor(){ super('main'); }
    create(){
      // floor
      this.add.tileSprite(0,0,W,H,'floor').setOrigin(0);

      // conveyor belt across center
      this.beltY = H/2;
      for(let x=32;x<W;x+=64){
        this.add.sprite(x,this.beltY,'conveyor').play('belt_move');
      }

      // belt collision zone
      this.beltZone = this.add.zone(W/2,this.beltY,W,32);
      this.physics.world.enable(this.beltZone);
      this.beltZone.body.setAllowGravity(false).setImmovable(true);

      // groups
      this.products = this.physics.add.group();
      this.zombies = this.physics.add.group();
      this.bullets = this.physics.add.group({allowGravity:false});
      this.drops = this.physics.add.group({allowGravity:false});

      // UI
      this.add.image(W-32,32,'coin');
      this.coinText = this.add.text(W-48,24,'0',{fontSize:18,color:'#fff'}).setOrigin(1,0);
      this.hpText = this.add.text(16,24,'HP: 100',{fontSize:18,color:'#fff'});

      this.buildSlots();

      // collisions
      this.physics.add.overlap(this.bullets,this.zombies,(b,z)=>{
        z.hp -= b.damage; b.destroy();
        if(z.hp<=0) this.killZombie(z);
      });
      this.physics.add.collider(this.zombies,this.beltZone,(z)=>{
        this.flash(z);
        baseHP -= 10;
        z.destroy();
        this.updateUI();
      });
      this.physics.add.overlap(this.zombies,this.products,(z,p)=>{
        this.flash(z);
        p.hp -= 10;
        if(p.hp<=0) p.destroy();
      });

      // spawn timer
      this.time.addEvent({delay:2000,loop:true,callback:()=>this.spawnZombie()});
    }

    buildSlots(){
      for(let i=0;i<3;i++){
        const x=80+i*72, y=H-64;
        const slot=this.add.rectangle(x,y,64,64,0x222222).setStrokeStyle(2,0xffffff);
        if(i===0){
          this.add.image(x,y,'turret');
          this.add.image(x-16,y+24,'coin').setScale(0.75);
          this.add.text(x+4,y+16,'50',{fontSize:14,color:'#fff'});
          slot.setInteractive({useHandCursor:true});
          slot.on('pointerdown',()=>{
            if(coins>=50){
              coins-=50; this.spawnProduct(); this.updateUI();
            }
          });
        }
      }
    }

    spawnProduct(){
      const p=this.physics.add.image(32,this.beltY,'turret');
      p.speed=2;
      p.range=160;
      p.damage=30;
      p.fireRate=1000;
      p.cooldown=0;
      p.hp=100;
      p.body.setAllowGravity(false);
      this.products.add(p);
    }

    spawnZombie(){
      const side=Phaser.Math.Between(0,3);
      let x,y;
      if(side===0){ x=Phaser.Math.Between(0,W); y=-20; }
      else if(side===1){ x=W+20; y=Phaser.Math.Between(0,H); }
      else if(side===2){ x=Phaser.Math.Between(0,W); y=H+20; }
      else { x=-20; y=Phaser.Math.Between(0,H); }
      const z=this.physics.add.sprite(x,y,'zombie');
      z.anims.play('zombie_walk');
      z.hp=100;
      z.body.setAllowGravity(false);
      this.zombies.add(z);
      this.physics.moveTo(z,W/2,this.beltY,30);
    }

    killZombie(z){
      const drop=this.add.image(z.x,z.y,'coin').setInteractive({useHandCursor:true});
      this.drops.add(drop);
      drop.on('pointerdown',()=>{ coins+=10; drop.destroy(); this.updateUI(); });
      z.destroy();
    }

    flash(obj){
      obj.setTintFill(0xffffff);
      this.time.delayedCall(100,()=>obj.clearTint());
    }

    fireLaser(p,target){
      const b=this.physics.add.image(p.x,p.y,'laser');
      b.damage=p.damage;
      this.physics.moveTo(b,target.x,target.y,400);
      this.bullets.add(b);
      this.time.delayedCall(500,()=>b.destroy());
    }

    getTarget(p){
      let best=null, bestD=1e9;
      this.zombies.getChildren().forEach(z=>{
        const d=Phaser.Math.Distance.Between(p.x,p.y,z.x,z.y);
        if(d<p.range && d<bestD){ best=z; bestD=d; }
      });
      return best;
    }

    update(_t,dt){
      this.products.getChildren().forEach(p=>{
        p.x += p.speed;
        if(p.x>W+32) p.destroy();
        p.cooldown -= dt;
        if(p.cooldown<=0){
          const t=this.getTarget(p);
          if(t){
            this.fireLaser(p,t);
            p.cooldown=p.fireRate;
          }
        }
      });
      this.zombies.getChildren().forEach(z=>{
        if(z.body) z.setFlipX(z.body.velocity.x>0);
      });
    }

    updateUI(){
      this.coinText.setText(coins);
      this.hpText.setText('HP: '+baseHP);
    }
  }

  const config={
    type:Phaser.AUTO,
    width:W,height:H,
    parent:'game',
    backgroundColor:'#1e1b1b',
    physics:{default:'arcade',arcade:{debug:false}},
    scene:[Boot,Title,Quest,Main]
  };
  new Phaser.Game(config);
})();
</script>
</body>
</html>

